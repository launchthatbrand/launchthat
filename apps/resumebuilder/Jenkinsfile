pipeline {
    agent any

    parameters {
        string(name: 'CLIENT_BRANCH', defaultValue: 'dev', description: 'The branch to push to in the client repository')
    }

    environment {
        // Define environment variables
        APP_NAME = 'resumebuilder'
        APP_DIR = 'apps/resumebuilder'
        // These credentials should be configured in Jenkins
        CLIENT_REPO_CREDS = credentials('jenkins-personal')
        CLIENT_REPO_URL = credentials('RESUMEBUILDER_REPO_URL')
        VERCEL_TOKEN = credentials('VERCEL_TOKEN')
        VERCEL_ORG_ID = credentials('QUCAUSA_VERCEL_ORG_ID') 
        VERCEL_PROJECT_ID = 'resumebuilder'
        // Node.js and package manager versions
        NODE_VERSION = '18.17.0'
        PNPM_VERSION = '9.15.4'
    }

    stages {
        stage('Setup Environment') {
            steps {
                script {
                    // Check if node is installed with correct version
                    sh '''
                    if ! command -v node &> /dev/null || [[ "$(node -v)" != *"${NODE_VERSION}"* ]]; then
                        echo "Node.js ${NODE_VERSION} needs to be installed"
                        
                        # Try to use NVM if available
                        if [ -s "$HOME/.nvm/nvm.sh" ]; then
                            echo "Using NVM to install Node.js"
                            . "$HOME/.nvm/nvm.sh"
                            nvm install ${NODE_VERSION}
                            nvm use ${NODE_VERSION}
                        else
                            # Try to install Node.js directly
                            echo "NVM not found, trying to install Node.js directly"
                            if command -v curl &> /dev/null; then
                                echo "Downloading and installing Node.js using curl"
                                curl -sL https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-linux-x64.tar.gz -o node.tar.gz
                                mkdir -p $HOME/nodejs
                                tar -xzf node.tar.gz -C $HOME/nodejs --strip-components=1
                                export PATH="$HOME/nodejs/bin:$PATH"
                                rm node.tar.gz
                            elif command -v wget &> /dev/null; then
                                echo "Downloading and installing Node.js using wget"
                                wget -q https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-linux-x64.tar.gz -O node.tar.gz
                                mkdir -p $HOME/nodejs
                                tar -xzf node.tar.gz -C $HOME/nodejs --strip-components=1
                                export PATH="$HOME/nodejs/bin:$PATH"
                                rm node.tar.gz
                            else
                                echo "ERROR: Neither curl nor wget are available. Cannot install Node.js."
                                exit 1
                            fi
                        fi
                    fi
                    '''
                    
                    // Verify Node.js installation
                    sh '''
                    if command -v node &> /dev/null; then
                        echo "Node.js installed successfully:"
                        node -v
                        
                        # Verify Node.js version meets requirements
                        NODE_VERSION=$(node -v | cut -d "v" -f 2)
                        REQUIRED_VERSION="18.0.0"
                        
                        if [ "$(printf '%s\\n' "$REQUIRED_VERSION" "$NODE_VERSION" | sort -V | head -n1)" = "$REQUIRED_VERSION" ]; then
                            echo "Node.js version $NODE_VERSION meets the minimum required version $REQUIRED_VERSION"
                        else
                            echo "ERROR: Node.js version $NODE_VERSION does not meet the minimum required version $REQUIRED_VERSION. Exiting build."
                            exit 1
                        fi
                    else
                        echo "ERROR: Failed to install Node.js. Exiting build."
                        exit 1
                    fi
                    '''
                    
                    // Check if pnpm is available
                    sh '''
                    if ! command -v pnpm &> /dev/null; then
                        echo "Installing pnpm using npm"
                        if command -v npm &> /dev/null; then
                            npm install -g pnpm@${PNPM_VERSION}
                        else
                            echo "npm not found, trying to install pnpm directly"
                            # Try to use curl or wget to install pnpm directly
                            if command -v curl &> /dev/null; then
                                curl -fsSL https://get.pnpm.io/install.sh | sh -
                            elif command -v wget &> /dev/null; then
                                wget -qO- https://get.pnpm.io/install.sh | sh -
                            else
                                echo "ERROR: Neither npm, curl, nor wget are available. Cannot install pnpm."
                                exit 1
                            fi
                            
                            # Add pnpm to PATH if installed via script
                            export PNPM_HOME="${HOME}/.local/share/pnpm"
                            export PATH="${PNPM_HOME}:${PATH}"
                        fi
                    fi
                    
                    # Verify installations
                    echo "Node.js version:"
                    node -v
                    echo "pnpm version:"
                    pnpm -v || echo "pnpm still not available"
                    '''
                }
            }
        }
        
        stage('Check for App Changes') {
            steps {
                script {
                    // Get the list of changed files in this commit
                    def changedFiles = sh(script: "git diff --name-only HEAD~1 HEAD || echo ''", returnStdout: true).trim()
                    
                    // Check if any of the changed files are in the resumebuilder app directory
                    def appChanged = changedFiles.split('\n').any { file -> 
                        file.startsWith('apps/resumebuilder/') 
                    }
                    
                    // Skip remaining stages if app wasn't changed
                    if (!appChanged && !currentBuild.getBuildCauses('UserIdCause')) {
                        echo "No changes detected in ${APP_DIR}. Skipping build."
                        currentBuild.result = 'ABORTED'
                        error("No changes detected in ${APP_DIR}. Build aborted.")
                    } else {
                        echo "Changes detected in ${APP_DIR} or manual build triggered. Proceeding with build."
                    }
                }
            }
        }
        
        stage('Checkout') {
            steps {
                // Checkout the monorepo
                checkout scm
            }
        }
        
        stage('Install Dependencies') {
            steps {
                // Install dependencies using pnpm
                sh '''
                # Ensure we're using the right Node.js version if nvm is available
                if [ -f "$HOME/.nvm/nvm.sh" ]; then
                    . "$HOME/.nvm/nvm.sh"
                    nvm use ${NODE_VERSION} || echo "Failed to use Node.js ${NODE_VERSION}"
                fi
                
                # Install dependencies
                echo "Installing dependencies with pnpm..."
                pnpm install
                '''
            }
        }
        
        stage('Install Vercel CLI') {
            steps {
                // Install Vercel CLI globally
                sh '''
                # Ensure we're using the right Node.js version if nvm is available
                if [ -f "$HOME/.nvm/nvm.sh" ]; then
                    . "$HOME/.nvm/nvm.sh"
                    nvm use ${NODE_VERSION} || echo "Failed to use Node.js ${NODE_VERSION}"
                fi
                
                # Install Vercel CLI
                echo "Installing Vercel CLI..."
                npm install -g vercel
                '''
            }
        }

        stage('Build with Vercel') {
            steps {
                // Build the app using Vercel build
                sh '''
                # Ensure we're using the right Node.js version if nvm is available
                if [ -f "$HOME/.nvm/nvm.sh" ]; then
                    . "$HOME/.nvm/nvm.sh"
                    nvm use ${NODE_VERSION} || echo "Failed to use Node.js ${NODE_VERSION}"
                fi
                
                cd ${APP_DIR}
                # Create a .vercel directory if it doesn't exist
                mkdir -p .vercel
                
                # Create project.json file with project settings
                echo '{"orgId":"'${VERCEL_ORG_ID}'","projectId":"'${VERCEL_PROJECT_ID}'"}' > .vercel/project.json
                
                # Build the app
                echo "Building with Vercel..."
                VERCEL_TOKEN=${VERCEL_TOKEN} vercel build
                '''
            }
        }
        
        stage('Deploy to Vercel') {
            steps {
                // Deploy to Vercel using the prebuilt flag
                sh '''
                # Ensure we're using the right Node.js version if nvm is available
                if [ -f "$HOME/.nvm/nvm.sh" ]; then
                    . "$HOME/.nvm/nvm.sh"
                    nvm use ${NODE_VERSION} || echo "Failed to use Node.js ${NODE_VERSION}"
                fi
                
                cd ${APP_DIR}
                echo "Deploying to Vercel..."
                VERCEL_TOKEN=${VERCEL_TOKEN} vercel deploy --prebuilt --prod
                '''
            }
        }
        
        stage('Push to Client Repo') {
            steps {
                script {
                    // Set up SSH for Git operations
                    sh '''
                    # Set up a temporary directory
                    TEMP_DIR=$(mktemp -d)
                    echo "Setting up client repository in ${TEMP_DIR}..."
                    
                    # Clone the client repository
                    echo "Cloning client repository..."
                    GIT_SSH_COMMAND="ssh -o StrictHostKeyChecking=no" git clone ${CLIENT_REPO_URL} ${TEMP_DIR}
                    
                    # Navigate to the client repo
                    cd ${TEMP_DIR}
                    
                    # Check if the target branch exists
                    echo "Checking for branch: ${CLIENT_BRANCH}"
                    if ! git show-ref --verify --quiet refs/remotes/origin/${CLIENT_BRANCH}; then
                        echo "Branch ${CLIENT_BRANCH} doesn't exist, creating it..."
                        
                        # Create the branch from current HEAD
                        git checkout -b ${CLIENT_BRANCH}
                    else
                        # Branch exists, check it out
                        echo "Branch ${CLIENT_BRANCH} exists, checking it out..."
                        git checkout ${CLIENT_BRANCH} || git checkout -b ${CLIENT_BRANCH} origin/${CLIENT_BRANCH}
                    fi
                    
                    # Clear existing content but keep .git
                    echo "Clearing existing content..."
                    find . -mindepth 1 -maxdepth 1 -not -path "./.git" -exec rm -rf {} \\;
                    
                    # Copy the app source code (excluding .git, node_modules, etc.)
                    echo "Copying app source code..."
                    rsync -av --exclude='.git' --exclude='node_modules' --exclude='.turbo' ${WORKSPACE}/${APP_DIR}/ ${TEMP_DIR}/
                    
                    # Copy Vercel build output to ensure it's available
                    echo "Copying Vercel build output..."
                    mkdir -p .vercel
                    rsync -av ${WORKSPACE}/${APP_DIR}/.vercel/output/ .vercel/output/
                    
                    # Create a simple deployment script for the client
                    echo "Creating deployment script..."
                    cat > deploy-to-vercel.sh << 'EOL'
#!/bin/bash
# Script to deploy the pre-built output to Vercel
# Requires Vercel CLI and authentication token

# Check if Vercel CLI is installed
if ! command -v vercel &> /dev/null; then
    echo "Vercel CLI not found. Installing..."
    npm install -g vercel
fi

# Deploy the pre-built app
echo "Deploying pre-built app to Vercel..."
vercel deploy --prebuilt --prod

echo "Deployment complete!"
EOL
                    chmod +x deploy-to-vercel.sh
                    
                    # Create a README explaining the deployment process
                    echo "Creating documentation..."
                    cat > VERCEL_DEPLOYMENT.md << 'EOL'
# Vercel Deployment

This repository contains a pre-built Next.js application ready for deployment to Vercel.

## Deployment Options

### Option 1: Manual Deployment

1. Make sure you have Vercel CLI installed:
   ```
   npm install -g vercel
   ```

2. Authenticate with Vercel:
   ```
   vercel login
   ```

3. Run the deployment script:
   ```
   ./deploy-to-vercel.sh
   ```

### Option 2: Vercel Dashboard

1. Connect this repository to Vercel through the Vercel dashboard.
2. Configure the build settings:
   - Framework Preset: Next.js
   - Build Command: Skip the build command, as the app is pre-built
   - Output Directory: .vercel/output

## Important Notes

- The `.vercel/output` directory contains the pre-built application.
- Do not delete this directory as it contains the production-ready build.
- Updates to this repository are pushed automatically from the monorepo build system.
EOL
                    
                    # Add information about the branch
                    echo "Adding branch information..."
                    echo "
## Branch Information

This code is on the ${CLIENT_BRANCH} branch of the repository." >> VERCEL_DEPLOYMENT.md
                    
                    # Commit and push changes
                    echo "Committing changes..."
                    git config user.name "Jenkins CI"
                    git config user.email "jenkins@example.com"
                    git add .
                    git commit -m "Deploy: Pre-built app $(date) to branch ${CLIENT_BRANCH} from monorepo CI" || echo "No changes to commit"
                    
                    # Push to the specified branch
                    echo "Pushing to branch: ${CLIENT_BRANCH}..."
                    GIT_SSH_COMMAND="ssh -o StrictHostKeyChecking=no" git push origin ${CLIENT_BRANCH}
                    
                    # Clean up
                    echo "Cleaning up temporary directory..."
                    cd ${WORKSPACE}
                    rm -rf ${TEMP_DIR}
                    '''
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "Cleaning workspace after build"
                cleanWs()
            }
        }
        success {
            script {
                echo "Successfully built and deployed ${env.APP_NAME} to Vercel and client repository branch ${params.CLIENT_BRANCH}"
            }
        }
        failure {
            script {
                echo "Failed to build or deploy ${env.APP_NAME}"
                echo "Check the Jenkins logs for more information"
            }
        }
    }
} 